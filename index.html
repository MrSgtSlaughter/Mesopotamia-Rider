<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mesopotamia Rider</title>

<link rel="icon" href="TemplateData/favicon.ico" />
<link rel="stylesheet" href="TemplateData/style.css" />
<script src="TemplateData/UnityProgress.js"></script>
<script src="Build/UnityLoader.js"></script>

<!-- Firebase init -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    orderBy,
    limit,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // YOUR FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyBTq5Yhu0CC4T0J2pgDD0zyan3i1PicxOc",
    authDomain: "mesopotamia-rider-leaderboard.firebaseapp.com",
    projectId: "mesopotamia-rider-leaderboard",
    storageBucket: "mesopotamia-rider-leaderboard.firebasestorage.app",
    messagingSenderId: "469063803329",
    appId: "1:469063803329:web:823d63cb02bf5096d04f40",
    measurementId: "G-R7YH8DDBE0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // expose to the non-module script below
  window._db = db;
  window._firestoreFns = { collection, addDoc, query, orderBy, limit, getDocs };
</script>

<style>
  body {
    margin: 0;
    background-color: #0f172a; /* dark navy */
    color: #f8fafc;           /* off-white */
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  .layout-root {
    display: grid;
    grid-template-columns: 1fr 320px; /* game big, sidebar skinny */
    gap: 1rem;
    padding: 1rem;
    height: 100vh;
    box-sizing: border-box;
  }

  /* LEFT: game container card */
  .game-wrapper {
    background-color: #1e293b;
    border-radius: 1rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    position: relative;

    /* allow scroll if Unity canvas is taller than viewport */
    overflow: auto;
    min-height: 60vh;
    max-height: 100vh;

    display: flex;
    align-items: center;
    justify-content: center;
  }

  #gameContainer {
    width: 960px;
    max-width: 100%;

    height: 600px;
    max-height: 80vh;

    margin: auto;
    background: #000;
    transition: filter 0.15s ease;
  }

  /* RIGHT: sidebar card */
  .sidebar {
    background-color: #1e293b;
    border-radius: 1rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    padding: 1rem 1rem 2rem;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .sidebar h2 {
    margin: 0 0 .5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #38bdf8; /* cyan */
    letter-spacing: -0.03em;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    font-size: .9rem;
    padding: .4rem .6rem;
    background: #0f172a;
    border-radius: .5rem;
    margin-bottom: .4rem;
    border: 1px solid #1e293b;
  }

  .btn {
    appearance: none;
    background-color: #38bdf8;
    color: #0f172a;
    border: 0;
    font-weight: 600;
    font-size: .9rem;
    border-radius: .5rem;
    padding: .6rem .8rem;
    cursor: pointer;
    width: 100%;
    text-align: center;
    margin-top: .5rem;
  }
  .btn:active {
    transform: scale(.98);
  }

  .panel {
    background: #0f172a;
    border-radius: .75rem;
    padding: .75rem;
    margin-top: 1rem;
    flex: 1;
    overflow: auto;
    min-height: 0;
  }

  .panel h3 {
    margin: 0 0 .5rem;
    font-size: .9rem;
    font-weight: 500;
    color: #facc15; /* yellow */
  }

  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .8rem;
  }
  .leaderboard-table th {
    text-align: left;
    font-weight: 600;
    padding-bottom: .5rem;
    color: #94a3b8;
  }
  .leaderboard-table td {
    padding: .25rem 0;
    border-bottom: 1px solid #334155;
    color: #f8fafc;
  }

  /* OVERLAY for quiz + score submit */
  .overlay-bg {
    position: absolute;
    inset: 0;
    background: rgba(15,23,42,.9); /* almost black */
    color: #f8fafc;
    display: none;                /* turned on with JS */
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 9999;
  }

  .overlay-card {
    background: #1e293b;
    border-radius: 1rem;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 40px rgba(0,0,0,.8);
    padding: 1rem 1.25rem 1.5rem;
  }

  .overlay-card h2 {
    margin-top: 0;
    font-size: 1rem;
    color: #38bdf8;
    font-weight: 600;
    letter-spacing: -0.03em;
  }

  .overlay-card p.prompt {
    font-size: .9rem;
    line-height: 1.4;
    margin: .5rem 0 1rem 0;
  }

  .choices {
    display: grid;
    gap: .5rem;
    margin-bottom: 1rem;
  }

  .choice-btn {
    background: #0f172a;
    border-radius: .5rem;
    border: 2px solid #334155;
    color: #f8fafc;
    text-align: left;
    padding: .6rem .75rem;
    cursor: pointer;
    font-size: .85rem;
    font-weight: 500;
    line-height: 1.3;
  }
  .choice-btn.correct {
    border-color: #22c55e;
    background: #064e3b;
  }
  .choice-btn.wrong {
    border-color: #ef4444;
    background: #450a0a;
  }

  .result-msg {
    font-size: .8rem;
    min-height: 1.2em;
    color: #facc15;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .name-input-row {
    display: flex;
    gap: .5rem;
    margin-bottom: 1rem;
  }

  .name-input-row input {
    flex: 1;
    border-radius: .5rem;
    border: 2px solid #334155;
    background: #0f172a;
    padding: .6rem .75rem;
    color: #f8fafc;
    font-size: .9rem;
  }
  .name-input-row input:focus {
    outline: 2px solid #38bdf8;
  }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    .layout-root {
      grid-template-columns: 1fr;
      grid-template-rows: auto auto;
      height: auto;
    }

    .game-wrapper {
      max-height: none;
      min-height: 50vh;
    }

    #gameContainer {
      max-width: 100%;
      max-height: 60vh;
    }
  }
</style>
</head>
<body>

<div class="layout-root">

  <!-- LEFT: GAME -->
  <main class="game-wrapper">
    <div id="gameContainer"></div>

    <!-- Overlay for quiz + submit score -->
    <div class="overlay-bg" id="overlayBg">
      <div class="overlay-card" id="overlayCard">
        <!-- JS injects here -->
      </div>
    </div>
  </main>

  <!-- RIGHT: SIDEBAR -->
  <aside class="sidebar">
    <h2>Mesopotamia Rider</h2>

    <div class="stat-row">
      <span>Quiz Points</span>
      <strong id="quizPoints">0</strong>
    </div>

    <div class="stat-row">
      <span>Questions Correct</span>
      <strong id="questionsCorrect">0</strong>
    </div>

    <div class="stat-row">
      <span>Questions Seen</span>
      <strong id="questionsSeen">0</strong>
    </div>

    <button class="btn" id="saveScoreBtn">Submit Score to Leaderboard</button>

    <div class="panel">
      <h3>Top Riders (Class)</h3>
      <table class="leaderboard-table" id="leaderboardTable">
        <thead>
          <tr><th>Name</th><th>Score</th></tr>
        </thead>
        <tbody id="leaderboardBody">
          <!-- filled in by JS -->
        </tbody>
      </table>
    </div>
  </aside>

</div>

<script>
  // =========================================================
  // 1. UNITY GAME BOOT
  // =========================================================
  // Make sure this filename matches the .json in your Build/ folder.
  // If it's different, fix it here.
  var gameInstance = UnityLoader.instantiate(
    "gameContainer",
    "Build/SnowRider3D-gd-1.json",
    {
      onProgress: function (gameInstance, progress) {
        UnityProgress(gameInstance, progress);
      }
    }
  );

  const gameDiv = document.getElementById("gameContainer");

  // overlayActive = true whenever quiz / submit popup is showing
  let overlayActive = false;

  // Dim game + block mouse clicks while overlay is up
  function disableGame() {
    gameDiv.style.pointerEvents = "none";
    gameDiv.style.filter = "brightness(0.4)";
  }

  // Restore game controls after overlay closes
  function enableGame() {
    gameDiv.style.pointerEvents = "auto";
    gameDiv.style.filter = "none";
  }

  // =========================================================
  // 2. KEYBOARD CONTROL ARBITER (THIS IS THE FIX)
  // =========================================================
  // We ONLY block Unity's keys if:
  // - overlay is open, AND
  // - the user is NOT actively typing in an input inside the overlay.
  //
  // That way:
  // - During quiz / submit popup, snowboarder can't keep playing (good)
  // - When student is typing initials in <input>, keystrokes go to the box (good)
  // - After popup closes, overlayActive = false, Unity gets keys again (good)
  function eatKeysIfOverlay(e) {
    if (!overlayActive) return; // no popup? let Unity get keys normally

    const activeEl = document.activeElement;
    const overlayCard = document.getElementById("overlayCard");

    // Are we focused on an input or textarea INSIDE the overlay card?
    const isTypingInInput =
      activeEl &&
      (activeEl.tagName === "INPUT" || activeEl.tagName === "TEXTAREA");

    const typingInOverlayInput =
      isTypingInInput && overlayCard.contains(activeEl);

    if (typingInOverlayInput) {
      // Student is typing initials. Let the browser handle the keys.
      // DO NOT block or preventDefault.
      return;
    }

    // Otherwise: quiz is up OR submit dialog is up,
    // but we're not inside a text box.
    // Block the event so Unity can't move.
    e.stopPropagation();
    e.preventDefault();
  }

  // capture=true so we intercept keys BEFORE Unity's own listeners
  window.addEventListener("keydown", eatKeysIfOverlay, true);
  window.addEventListener("keypress", eatKeysIfOverlay, true);
  window.addEventListener("keyup", eatKeysIfOverlay, true);

  // =========================================================
  // 3. MESOPOTAMIA QUESTION BANK
  // =========================================================
  // answerIndex: 0 = A, 1 = B, 2 = C, 3 = D
  const questions = [
    {
      q: "What does the word \"Mesopotamia\" mean?",
      choices: [
        "A: Land of many mountains",
        "B: Land between two rivers",
        "C: The king's land",
        "D: Hot dry land"
      ],
      answerIndex: 1
    },
    {
      q: "Which two rivers were most important to Mesopotamia?",
      choices: [
        "A: Nile and Amazon",
        "B: Yellow and Indus",
        "C: Tigris and Euphrates",
        "D: Ohio and Mississippi"
      ],
      answerIndex: 2
    },
    {
      q: "Why did people settle in Mesopotamia?",
      choices: [
        "A: There were strong stone walls already built",
        "B: The rivers flooded and left rich soil for farming",
        "C: Gold mines were everywhere",
        "D: It stayed cool all year"
      ],
      answerIndex: 1
    },
    {
      q: "What is a city-state?",
      choices: [
        "A: A city that has no laws",
        "B: A city and the land around it that rules itself",
        "C: A city that belongs to another country far away",
        "D: A city with no army"
      ],
      answerIndex: 1
    },
    {
      q: "Which of these was one of the first major Sumerian city-states?",
      choices: [
        "A: Rome",
        "B: Athens",
        "C: Ur",
        "D: Beijing"
      ],
      answerIndex: 2
    },
    {
      q: "What was cuneiform?",
      choices: [
        "A: A type of army formation",
        "B: A kind of boat used on the rivers",
        "C: A tax paid to the king",
        "D: The writing system made of wedge-shaped marks"
      ],
      answerIndex: 3
    },
    {
      q: "Who were scribes in Sumerian society?",
      choices: [
        "A: Farmers who grew grain",
        "B: Warriors who protected the temples",
        "C: Traders who sold goods in other lands",
        "D: Trained writers who kept records"
      ],
      answerIndex: 3
    },
    {
      q: "What is a ziggurat?",
      choices: [
        "A: A round house made of wood",
        "B: A step-shaped temple in the center of the city",
        "C: A river boat used for fishing",
        "D: A type of armor for soldiers"
      ],
      answerIndex: 1
    },
    {
      q: "Why were ziggurats important?",
      choices: [
        "A: They stored extra grain underground",
        "B: They were used to train soldiers for war",
        "C: People believed the gods lived at the top",
        "D: They were market places for trade"
      ],
      answerIndex: 2
    },
    {
      q: "Which invention is credited to the Sumerians?",
      choices: [
        "A: Gunpowder",
        "B: The wheel",
        "C: Paper money",
        "D: The steam engine"
      ],
      answerIndex: 1
    },
    {
      q: "Who was Hammurabi?",
      choices: [
        "A: A farmer who invented irrigation",
        "B: A scribe who wrote the first story",
        "C: A Babylonian king known for his laws",
        "D: A god worshipped in the ziggurat"
      ],
      answerIndex: 2
    },
    {
      q: "Why is Hammurabi's Code important in history?",
      choices: [
        "A: It taught kids how to read cuneiform",
        "B: It was one of the first written sets of laws",
        "C: It explained how to build boats",
        "D: It forced everyone to become a soldier"
      ],
      answerIndex: 1
    },
    {
      q: "What problem did irrigation solve for Sumerian farmers?",
      choices: [
        "A: Too many snakes in the fields",
        "B: The land was covered in ice",
        "C: There was either too much or too little water",
        "D: Farmers didnâ€™t have enough workers"
      ],
      answerIndex: 2
    },
    {
      q: "What material did Sumerians use most to build houses and walls?",
      choices: [
        "A: Marble blocks",
        "B: Concrete",
        "C: Iron plates",
        "D: Sun-dried mud bricks"
      ],
      answerIndex: 3
    },
    {
      q: "Why was trade important in Mesopotamia?",
      choices: [
        "A: They had tons of metal and needed to get rid of it",
        "B: They had everything they needed already",
        "C: They lacked resources like wood and metal, so they traded surplus grain for them",
        "D: It was required by Hammurabi's Code"
      ],
      answerIndex: 2
    },
    {
      q: "Which social group had the MOST power in a Sumerian city-state?",
      choices: [
        "A: Slaves",
        "B: Farm workers",
        "C: Priests and kings",
        "D: Fishermen"
      ],
      answerIndex: 2
    },
    {
      q: "The Epic of Gilgamesh is important because it is one of the world's oldest known...",
      choices: [
        "A: Maps",
        "B: Religious laws",
        "C: Written stories/epics",
        "D: Math textbooks"
      ],
      answerIndex: 2
    },
    {
      q: "Why was Mesopotamia sometimes attacked by outside groups?",
      choices: [
        "A: It had huge mountains for hiding armies",
        "B: It was rich in crops and located in open, flat land",
        "C: It was surrounded by oceans that pirates wanted",
        "D: It had volcanoes people wanted to study"
      ],
      answerIndex: 1
    },
    {
      q: "Which of the following best describes the geography of Mesopotamia?",
      choices: [
        "A: Thick rainforest with heavy rain all year",
        "B: Large deserts and dry plains with rivers running through them",
        "C: Snowy mountains and icy lakes",
        "D: Cold tundra with no plants"
      ],
      answerIndex: 1
    },
    {
      q: "How did farming lead to the rise of cities in Mesopotamia?",
      choices: [
        "A: Farming made people move every day to chase animals",
        "B: Farming made people stop trading",
        "C: Farming created extra food, which let people do other jobs like builders, priests, and soldiers",
        "D: Farming removed the need for leaders"
      ],
      answerIndex: 2
    }
  ];

  // =========================================================
  // 4. SCORE STATE
  // =========================================================
  let quizPoints = 0;
  let questionsCorrect = 0;
  let questionsSeen = 0;

  function updateStatsUI() {
    document.getElementById("quizPoints").textContent = quizPoints;
    document.getElementById("questionsCorrect").textContent = questionsCorrect;
    document.getElementById("questionsSeen").textContent = questionsSeen;
  }

  // =========================================================
  // 5. OVERLAY HELPERS
  // =========================================================
  function showOverlay(htmlInner) {
    const overlayBg = document.getElementById("overlayBg");
    const overlayCard = document.getElementById("overlayCard");

    overlayCard.innerHTML = htmlInner;
    overlayBg.style.display = "flex";

    // mark overlay as active BEFORE focusing
    overlayActive = true;
    disableGame(); // dim the game / block pointer

    // focus the first input field so kids can immediately type initials
    const firstInput = overlayCard.querySelector("input,textarea");
    if (firstInput) {
      firstInput.focus();
      if (firstInput.select) firstInput.select();
    }
  }

  function hideOverlay() {
    const overlayBg = document.getElementById("overlayBg");
    overlayBg.style.display = "none";

    // critical: turn this OFF so Unity gets keys again
    overlayActive = false;
    enableGame();
  }

  // =========================================================
  // 6. QUIZ LOGIC
  // =========================================================
  const QUIZ_INTERVAL_MS = 45000; // ~45 seconds

  function pickQuestion() {
    return questions[Math.floor(Math.random() * questions.length)];
  }

  function showQuiz() {
    const qObj = pickQuestion();
    questionsSeen++;

    let choicesHTML = "";
    qObj.choices.forEach((c, idx) => {
      choicesHTML += `<button class="choice-btn" data-choice="${idx}">${c}</button>`;
    });

    const quizHTML = `
      <h2>Mesopotamia Checkpoint</h2>
      <p class="prompt">${qObj.q}</p>

      <div class="choices">
        ${choicesHTML}
      </div>

      <div class="result-msg" id="resultMsg"></div>

      <button class="btn" id="continueBtn" disabled>Continue</button>
    `;

    showOverlay(quizHTML);

    const choiceButtons = document.querySelectorAll(".choice-btn");
    const resultMsg = document.getElementById("resultMsg");
    const continueBtn = document.getElementById("continueBtn");

    let answered = false;

    choiceButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        if (answered) return;
        answered = true;

        const picked = parseInt(btn.dataset.choice, 10);
        if (picked === qObj.answerIndex) {
          btn.classList.add("correct");
          resultMsg.textContent = "Correct! +100 points.";
          quizPoints += 100;
          questionsCorrect += 1;
        } else {
          btn.classList.add("wrong");
          resultMsg.textContent = "Not quite. No points this time.";
          // show which was right
          choiceButtons[qObj.answerIndex].classList.add("correct");
        }

        // lock all answer buttons
        choiceButtons.forEach(b => {
          b.disabled = true;
        });

        updateStatsUI();
        continueBtn.disabled = false;
      });
    });

    continueBtn.addEventListener("click", () => {
      hideOverlay(); // VERY IMPORTANT: releases controls
    });
  }

  // Ask a quiz every interval
  const quizTimer = setInterval(showQuiz, QUIZ_INTERVAL_MS);

  // For testing, you can force the first quiz right away:
  // showQuiz();

  // =========================================================
  // 7. LEADERBOARD SAVE / LOAD (FIRESTORE)
  // =========================================================
  async function saveScoreFlow() {
    const saveHTML = `
      <h2>Submit Score</h2>
      <p class="prompt">Enter your initials or first name to post your score to the class leaderboard.</p>

      <div class="name-input-row">
        <input id="playerNameInput" maxlength="12" placeholder="Your name/initials" />
      </div>

      <div class="stat-row" style="margin-bottom:1rem; background:#1e293b; border:1px solid #334155; display:flex; justify-content:space-between;">
        <span>Total Quiz Points</span>
        <strong>${quizPoints}</strong>
      </div>

      <div class="result-msg" id="submitMsg"></div>

      <button class="btn" id="submitScoreBtn">Submit</button>
      <button class="btn" id="cancelSubmitBtn" style="margin-top:.5rem; background:#334155; color:#f8fafc;">Cancel</button>
    `;

    showOverlay(saveHTML);

    const cancelBtn = document.getElementById("cancelSubmitBtn");
    cancelBtn.addEventListener("click", () => {
      hideOverlay(); // releases controls
    });

    const submitBtn = document.getElementById("submitScoreBtn");
    submitBtn.addEventListener("click", async () => {
      const nameField = document.getElementById("playerNameInput");
      const msgEl = document.getElementById("submitMsg");

      const rawName = nameField.value.trim();
      if (!rawName) {
        msgEl.textContent = "Please enter a name.";
        return;
      }

      // Truncate for privacy
      const shortName = rawName.substring(0, 12);

      try {
        const db = window._db;
        const { collection, addDoc } = window._firestoreFns;

        await addDoc(collection(db, "mesoLeaderboard"), {
          name: shortName,
          score: quizPoints,
          ts: Date.now()
        });

        msgEl.textContent = "Score submitted!";
        loadLeaderboard();
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Error saving score.";
      }
    });
  }

  async function loadLeaderboard() {
    try {
      const db = window._db;
      const { collection, query, orderBy, limit, getDocs } = window._firestoreFns;

      const q = query(
        collection(db, "mesoLeaderboard"),
        orderBy("score", "desc"),
        limit(10)
      );

      const snap = await getDocs(q);
      const rows = [];
      snap.forEach(doc => {
        const data = doc.data();
        rows.push(
          `<tr><td>${escapeHtml(data.name)}</td><td>${data.score}</td></tr>`
        );
      });

      document.getElementById("leaderboardBody").innerHTML = rows.join("");
    } catch (err) {
      console.error(err);
    }
  }

  function escapeHtml(str) {
    return (str || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // hook up sidebar button
  document.getElementById("saveScoreBtn").addEventListener("click", saveScoreFlow);

  // load leaderboard now
  loadLeaderboard();
</script>

</body>
</html>
